# 视频车道线检测工具

## 项目简介
这是一个基于传统计算机视觉算法的视频车道线检测工具，专注于实线车道线的识别与跟踪。该工具能够实时处理视频流，检测画面中的车道线，并在画面静止时输出稳定的线段结果，适用于道路监控、自动驾驶辅助等场景。

## 核心功能
- 实时检测视频中的实线车道线
- 自动判断画面是否静止（支持动态/静态场景切换）
- 静止状态下融合多帧结果，输出稳定的车道线
- 支持检测结果可视化（含原始坐标和归一化坐标）
- 自动保存检测数据至JSON文件，便于后续分析

## 算法流程
1. **图像预处理**：
   - 高斯模糊降噪
   - Canny边缘检测
   - 感兴趣区域(ROI)提取（聚焦道路区域）

2. **车道线检测**：
   - 霍夫变换检测直线
   - 基于角度过滤实线车道线
   - 直线聚类（合并相似角度的线段）
   - 线段延伸（将线段扩展至聚类边界）

3. **稳定性处理**：
   - 帧差异分析判断画面是否静止
   - 静止状态下收集多帧线段并融合
   - 输出稳定的车道线结果

## 使用方法

### 环境要求
- Python 3.6+
- OpenCV (cv2)
- NumPy

安装依赖：
```bash
pip install opencv-python numpy
```

### 基本使用
1. 修改`main()`函数中的路径参数：
   ```python
   input_video = "tunnel.mp4"  # 输入视频路径
   output_video = "output_stable_lanes.mp4"  # 输出视频路径
   json_output = "detection_results.json"  # 完整检测数据
   stable_output = "stable_lanes.json"  # 稳定线段结果
   ```

2. 运行脚本：
   ```bash
   python lane_detector.py
   ```

### 输出文件说明
- **输出视频**：带车道线标记和状态指示的视频
- **完整检测数据(JSON)**：包含每帧的检测结果、线段坐标等信息
- **稳定线段结果(JSON)**：静止状态下融合后的稳定车道线数据

## 参数配置
可通过修改`VideoLaneDetector`类的初始化参数调整检测效果：

| 参数 | 说明 | 默认值 |
|------|------|--------|
| `gaussian_kernel_size` | 高斯模糊核大小 | 5 |
| `canny_high_threshold` | Canny边缘检测高阈值比例 | 0.9 |
| `hough_threshold` | 霍夫变换阈值 | 80 |
| `hough_min_line_length` | 最小线段长度 | 100 |
| `roi_top_ratio` | 感兴趣区域顶部比例 | 0.3 |
| `solid_angle_range` | 实线角度范围(度) | (-80,-10)+(10,80) |
| `cluster_angle_threshold` | 聚类角度阈值 | 5.0 |
| `frame_diff_threshold` | 帧差异阈值 | 5.0 |

## 结果可视化说明
输出视频中包含以下元素：
- 彩色线段：检测到的车道线（不同聚类用不同颜色）
- 端点圆圈：线段的起点和终点
- 状态文字：
  - "State: Moving"：画面处于动态状态
  - "State: Static"：画面处于静止状态
  - "State: Static (Stable Lines)"：已生成稳定线段

## 数据格式说明
JSON输出文件中的线段格式：
- 原始坐标：`[x1, y1, x2, y2]`（像素坐标）
- 归一化坐标：`[x1/w, y1/h, x2/w, y2/h]`（范围0-1，便于不同尺寸图像兼容）

## 注意事项
1. 建议输入视频为道路前方视角，车道线清晰可见
2. 复杂光照条件（如逆光、隧道出入口）可能影响检测效果
3. 极端天气（雨、雪、大雾）可能导致检测精度下降
4. 对于动态场景（如车辆行驶中），主要输出实时检测结果；对于静态场景（如监控摄像头），会输出更稳定的融合结果